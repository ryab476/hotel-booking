<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-theme-bg-color: #4CAF50; /* –°–≤–µ—Ç–ª–æ-—Å–∞–ª–∞—Ç–æ–≤—ã–π —Ñ–æ–Ω */
      --tg-theme-text-color: #000000;
      --tg-theme-button-color: #3390ec;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-hint-color: #999999;
      --border-color: #4CAF50; /* –ó–µ–ª—ë–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      font-size: 16px;
      line-height: 1.5;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 24px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    select,
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color); /* –ó–µ–ª—ë–Ω–∞—è —Ä–∞–º–∫–∞ */
      border-radius: 10px; /* –°–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ —É–≥–ª—ã */
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      font-size: 16px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    button {
      width: 100%;
      padding: 14px;
      background-color: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border: none;
      border-radius: 10px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .error {
      color: #ff4444;
      font-size: 14px;
      margin-top: 8px;
    }

    .name-row,
    .passport-row {
      display: flex;
      gap: 12px;
    }

    .name-row .form-group,
    .passport-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üè® –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞<br>(GitHub)</h1>

    <!-- –í—ã–±–æ—Ä –≥–æ—Å—Ç–∏–Ω–∏—Ü—ã -->
    <div class="form-group">
      <label for="hotel_id">–ì–æ—Å—Ç–∏–Ω–∏—Ü–∞ *</label>
      <select id="hotel_id" required>
        <option value="">‚Äî –ó–∞–≥—Ä—É–∑–∫–∞... ‚Äî</option>
      </select>
    </div>

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
    <div class="form-group">
      <label for="room_category_id">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–æ–º–µ—Ä–∞ *</label>
      <select id="room_category_id" required disabled>
        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Å—Ç–∏–Ω–∏—Ü—É</option>
      </select>
    </div>

    <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π -->
    <div class="form-group">
      <label for="guests">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π *</label>
      <input type="number" id="guests" min="1" max="2" value="1" required disabled />
      <div id="guestsError" class="error"></div>
    </div>

    <!-- –§–ò–û -->
    <div class="name-row">
      <div class="form-group">
        <label for="lastName">–§–∞–º–∏–ª–∏—è *</label>
        <input type="text" id="lastName" placeholder="–ò–≤–∞–Ω–æ–≤" maxlength="50" required disabled />
      </div>
      <div class="form-group">
        <label for="firstName">–ò–º—è *</label>
        <input type="text" id="firstName" placeholder="–ò–≤–∞–Ω" maxlength="50" required disabled />
      </div>
    </div>
    <div class="form-group">
      <label for="middleName">–û—Ç—á–µ—Å—Ç–≤–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
      <input type="text" id="middleName" placeholder="–ò–≤–∞–Ω–æ–≤–∏—á" maxlength="50" disabled />
    </div>

    <!-- Email -->
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="ivan@example.com" maxlength="100" disabled />
    </div>

    <!-- –ü–∞—Å–ø–æ—Ä—Ç -->
    <div class="passport-row">
      <div class="form-group">
        <label for="passportSeries">–°–µ—Ä–∏—è *</label>
        <input type="text" id="passportSeries" placeholder="1234" maxlength="4" required disabled />
      </div>
      <div class="form-group">
        <label for="passportNumber">–ù–æ–º–µ—Ä *</label>
        <input type="text" id="passportNumber" placeholder="567890" maxlength="6" required disabled />
      </div>
    </div>

    <div class="form-group">
      <label for="issueDate">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ *</label>
      <input type="date" id="issueDate" required disabled />
    </div>

    <div class="form-group">
      <label for="issuedBy">–ö–µ–º –≤—ã–¥–∞–Ω *</label>
      <input type="text" id="issuedBy" placeholder="–û–í–î —Ä–∞–π–æ–Ω–∞, –≥. –ú–æ—Å–∫–≤–∞" maxlength="200" required disabled />
    </div>

    <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
    <div class="form-group">
      <label for="phone">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω *</label>
      <input type="tel" id="phone" placeholder="+7 (999) 123-45-67" required disabled />
    </div>

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
    <div class="form-group">
      <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
      <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω—É–∂–Ω–∞ –¥–µ—Ç—Å–∫–∞—è –∫—Ä–æ–≤–∞—Ç–∫–∞" disabled></textarea>
    </div>

    <!-- –î–∞—Ç—ã -->
    <div class="form-group">
      <label for="check_in">–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞ *</label>
      <input type="date" id="check_in" required disabled />
    </div>

    <div class="form-group">
      <label for="check_out">–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞ *</label>
      <input type="date" id="check_out" required disabled />
      <div id="dateError" class="error"></div>
    </div>

    <button id="bookBtn">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>

  <script>
    const WebApp = window.Telegram.WebApp;

    if (!WebApp) {
      alert("Telegram WebApp –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram.");
      throw new Error("WebApp not available");
    }

    WebApp.ready();
    WebApp.expand();

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞—ë–º —Ü–≤–µ—Ç–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ç–µ–º—É Telegram
    document.documentElement.style.setProperty('--tg-theme-bg-color', '#d9f2d9');
    document.documentElement.style.setProperty('--tg-theme-text-color', '#000000');
    document.documentElement.style.setProperty('--tg-theme-button-color', '#3390ec');
    document.documentElement.style.setProperty('--tg-theme-button-text-color', '#ffffff');
    document.documentElement.style.setProperty('--tg-theme-hint-color', '#999999');

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('issueDate').max = today;
    document.getElementById('check_in').min = today;
    document.getElementById('check_out').min = today;

    const hotelSelect = document.getElementById('hotel_id');
    const categorySelect = document.getElementById('room_category_id');
    const guestsInput = document.getElementById('guests');
    const formFields = document.querySelectorAll('input:not([type="radio"]), select, textarea');
    const bookBtn = document.getElementById('bookBtn');

    // === –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î ===
    let hotels = [];
    let categoriesByHotel = {};

    async function loadHotelsAndCategories() {
      try {
        // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL API
        const response = await fetch('http://localhost:8000/api/hotels-with-categories');
        hotels = await response.json();

        hotelSelect.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
        hotels.forEach(hotel => {
          const opt = document.createElement('option');
          opt.value = hotel.id;
          opt.textContent = hotel.name;
          opt.dataset.categories = JSON.stringify(hotel.categories);
          hotelSelect.appendChild(opt);
        });
      } catch (e) {
        WebApp.showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " + e.message);
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Å—Ç–∏–Ω–∏—Ü –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:", e);
      }
    }

    // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –≥–æ—Å—Ç–∏–Ω–∏—Ü—ã ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –∫—ç—à–∞
    hotelSelect.addEventListener('change', () => {
      const selectedOption = hotelSelect.selectedOptions[0];
      const categories = selectedOption ? JSON.parse(selectedOption.dataset.categories || '[]') : [];
      
      categorySelect.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = `${cat.name} ‚Äî ${cat.price || '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`;
        categorySelect.appendChild(opt);
      });
      
      categorySelect.disabled = categories.length === 0;

      // –ù–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≥–æ—Å—Ç–∏–Ω–∏—Ü—ã, —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      if (categories.length === 0) {
        enableFields(false);
      } else {
        // –ï—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≥–æ—Å—Ç–∏–Ω–∏—Ü—ã), –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏
        if (categorySelect.value) {
          enableFields(true);
        } else {
          enableFields(false); // –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
        }
      }
    });

    // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    categorySelect.addEventListener('change', () => {
      if (categorySelect.value) {
        enableFields(true);
      } else {
        enableFields(false);
      }
    });

    // === –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø enableFields ===
    function enableFields(enable) {
      formFields.forEach(el => {
        // –ò—Å–∫–ª—é—á–∞–µ–º –æ–±–∞ –ø–æ–ª—è ‚Äî –≥–æ—Å—Ç–∏–Ω–∏—Ü—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        if (el.id !== 'hotel_id' && el.id !== 'room_category_id') {
          el.disabled = !enable;
        }
      });
      bookBtn.disabled = !enable;
    }

    document.getElementById('check_in').addEventListener('change', function () {
      document.getElementById('check_out').min = this.value || today;
    });

    document.getElementById('passportSeries').addEventListener('input', function (e) {
      this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });
    document.getElementById('passportNumber').addEventListener('input', function (e) {
      this.value = this.value.replace(/\D/g, '').slice(0, 6);
    });

    document.getElementById('phone').addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.startsWith('8')) value = '7' + value.slice(1);
      if (!value.startsWith('7')) value = '7' + value;
      let formatted = '+7';
      if (value.length > 1) formatted += ' (' + value.slice(1, 4);
      if (value.length >= 4) formatted += ') ' + value.slice(4, 7);
      if (value.length >= 7) formatted += '-' + value.slice(7, 9);
      if (value.length >= 9) formatted += '-' + value.slice(9, 11);
      e.target.value = formatted;
    });
    
    function focusField(fieldId, message = "") {
      const field = document.getElementById(fieldId);
      if (field) {
        field.scrollIntoView({ behavior: "smooth", block: "center" });
        field.focus();
        if (message) {
          WebApp.showAlert(message);
        }
      }
    }
 
    bookBtn.addEventListener('click', () => {
      const hotel_id = hotelSelect.value;
      const room_category_id = categorySelect.value;
      const guests = parseInt(document.getElementById('guests').value);
      const lastName = document.getElementById('lastName').value.trim();
      const firstName = document.getElementById('firstName').value.trim();
      const middleName = document.getElementById('middleName').value.trim() || null;
      const email = document.getElementById('email').value.trim() || null;
      const passportSeries = document.getElementById('passportSeries').value;
      const passportNumber = document.getElementById('passportNumber').value;
      const issueDate = document.getElementById('issueDate').value;
      const issuedBy = document.getElementById('issuedBy').value.trim();
      const phoneRaw = document.getElementById('phone').value.replace(/\D/g, '');
      const comment = document.getElementById('comment').value.trim() || null;
      const check_in = document.getElementById('check_in').value;
      const check_out = document.getElementById('check_out').value;

      const guestsError = document.getElementById('guestsError');
      const dateError = document.getElementById('dateError');
      guestsError.textContent = '';
      dateError.textContent = '';

      if (!hotel_id) { focusField('hotel_id', '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Å—Ç–∏–Ω–∏—Ü—É'); return; }
      if (!room_category_id) { focusField('room_category_id', '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }
      if (isNaN(guests) || guests < 1) {
        guestsError.textContent = '–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π';
        focusField('guests');
        return;
      }
      // –£–±–∏—Ä–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç HOTELS_CONFIG, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –æ—Å—Ç–∞–≤–∏–º –∂—ë—Å—Ç–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, –Ω–æ –º–æ–∂–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å maxGuests –∏–∑ API
      const maxGuests = 4; // –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ API –∏ —Ö—Ä–∞–Ω–∏—Ç—å –≤ categoriesByHotel[hotel_id][room_category_id].maxGuests
      if (guests > maxGuests) {
        guestsError.textContent = `–ú–∞–∫—Å–∏–º—É–º ${maxGuests} –≥–æ—Å—Ç–µ–π`;
        focusField('guests');
        return;
      }
      if (!lastName) { focusField('lastName', '–§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞'); return; }
      if (!firstName) { focusField('firstName', '–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'); return; }
      if (passportSeries.length !== 4) { focusField('passportSeries', '–°–µ—Ä–∏—è ‚Äî 4 —Ü–∏—Ñ—Ä—ã'); return; }
      if (passportNumber.length !== 6) { focusField('passportNumber', '–ù–æ–º–µ—Ä ‚Äî 6 —Ü–∏—Ñ—Ä'); return; }
      if (!issueDate) { focusField('issueDate', '–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞'); return; }
      if (!issuedBy) { focusField('issuedBy', '–£–∫–∞–∂–∏—Ç–µ, –∫–µ–º –≤—ã–¥–∞–Ω'); return; }
      if (phoneRaw.length < 11) { focusField('phone', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω'); return; }
      if (!check_in) { focusField('check_in', '–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞'); return; }
      if (!check_out) { focusField('check_out', '–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞'); return; }
      if (new Date(check_out) <= new Date(check_in)) {
        dateError.textContent = '–í—ã–µ–∑–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–∑–∂–µ –∑–∞–µ–∑–¥–∞';
        focusField('check_out');
        return;
      }
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        focusField('email', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
        return;
      }

      const payload = {
        hotel_id: parseInt(hotel_id),
        room_category_id: parseInt(room_category_id),
        guests,
        lastName,
        firstName,
        middleName,
        email,
        passportSeries,
        passportNumber,
        issueDate,
        issuedBy,
        phone: '+7' + phoneRaw.slice(1),
        comment,
        check_in,
        check_out
      };

      WebApp.showAlert("–î–∞–Ω–Ω—ã–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã", payload);
      try {
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:', payload);
        WebApp.sendData(JSON.stringify(payload));
        //WebApp.close();
      } catch (e) {
        WebApp.showAlert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
      }
    });

    // === –ó–ê–ì–†–£–ñ–ê–ï–ú –î–ê–ù–ù–´–ï –ü–†–ò –°–¢–ê–†–¢–ï ===
    loadHotelsAndCategories();
  </script>
</body>
</html>