<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-theme-bg-color: #4CAF50; /* –°–≤–µ—Ç–ª–æ-—Å–∞–ª–∞—Ç–æ–≤—ã–π —Ñ–æ–Ω */
      --tg-theme-text-color: #000000;
      --tg-theme-button-color: #3390ec;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-hint-color: #999999;
      --border-color: #4CAF50; /* –ó–µ–ª—ë–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      font-size: 16px;
      line-height: 1.5;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 24px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    select,
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color); /* –ó–µ–ª—ë–Ω–∞—è —Ä–∞–º–∫–∞ */
      border-radius: 10px; /* –°–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ —É–≥–ª—ã */
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      font-size: 16px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    button {
      width: 100%;
      padding: 14px;
      background-color: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border: none;
      border-radius: 10px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .error {
      color: #ff4444;
      font-size: 14px;
      margin-top: 8px;
    }

    .name-row,
    .passport-row {
      display: flex;
      gap: 12px;
    }

    .name-row .form-group,
    .passport-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üè® –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞</h1>

    <!-- –í—ã–±–æ—Ä –≥–æ—Å—Ç–∏–Ω–∏—Ü—ã -->
    <div class="form-group">
      <label for="hotel_id">–ì–æ—Å—Ç–∏–Ω–∏—Ü–∞ *</label>
      <select id="hotel_id" required>
        <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
        <option value="1" data-name="–ê–ª—å—Ñ–∞">–ê–ª—å—Ñ–∞</option>
        <option value="2" data-name="–ë–µ—Ç–∞">–ë–µ—Ç–∞</option>
        <option value="3" data-name="–ì–∞–º–º–∞">–ì–∞–º–º–∞</option>
      </select>
    </div>

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
    <div class="form-group">
      <label for="room_category_id">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–æ–º–µ—Ä–∞ *</label>
      <select id="room_category_id" required disabled>
        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Å—Ç–∏–Ω–∏—Ü—É</option>
      </select>
    </div>

    <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π -->
    <div class="form-group">
      <label for="guests">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π *</label>
      <input type="number" id="guests" min="1" max="2" value="1" required disabled />
      <div id="guestsError" class="error"></div>
    </div>

    <!-- –§–ò–û -->
    <div class="name-row">
      <div class="form-group">
        <label for="lastName">–§–∞–º–∏–ª–∏—è *</label>
        <input type="text" id="lastName" placeholder="–ò–≤–∞–Ω–æ–≤" maxlength="50" required disabled />
      </div>
      <div class="form-group">
        <label for="firstName">–ò–º—è *</label>
        <input type="text" id="firstName" placeholder="–ò–≤–∞–Ω" maxlength="50" required disabled />
      </div>
    </div>
    <div class="form-group">
      <label for="middleName">–û—Ç—á–µ—Å—Ç–≤–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
      <input type="text" id="middleName" placeholder="–ò–≤–∞–Ω–æ–≤–∏—á" maxlength="50" disabled />
    </div>

    <!-- Email -->
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="ivan@example.com" maxlength="100" disabled />
    </div>

    <!-- –ü–∞—Å–ø–æ—Ä—Ç -->
    <div class="passport-row">
      <div class="form-group">
        <label for="passportSeries">–°–µ—Ä–∏—è *</label>
        <input type="text" id="passportSeries" placeholder="1234" maxlength="4" required disabled />
      </div>
      <div class="form-group">
        <label for="passportNumber">–ù–æ–º–µ—Ä *</label>
        <input type="text" id="passportNumber" placeholder="567890" maxlength="6" required disabled />
      </div>
    </div>

    <div class="form-group">
      <label for="issueDate">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ *</label>
      <input type="date" id="issueDate" required disabled />
    </div>

    <div class="form-group">
      <label for="issuedBy">–ö–µ–º –≤—ã–¥–∞–Ω *</label>
      <input type="text" id="issuedBy" placeholder="–û–í–î —Ä–∞–π–æ–Ω–∞, –≥. –ú–æ—Å–∫–≤–∞" maxlength="200" required disabled />
    </div>

    <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
    <div class="form-group">
      <label for="phone">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω *</label>
      <input type="tel" id="phone" placeholder="+7 (999) 123-45-67" required disabled />
    </div>

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
    <div class="form-group">
      <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
      <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω—É–∂–Ω–∞ –¥–µ—Ç—Å–∫–∞—è –∫—Ä–æ–≤–∞—Ç–∫–∞" disabled></textarea>
    </div>

    <!-- –î–∞—Ç—ã -->
    <div class="form-group">
      <label for="check_in">–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞ *</label>
      <input type="date" id="check_in" required disabled />
    </div>

    <div class="form-group">
      <label for="check_out">–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞ *</label>
      <input type="date" id="check_out" required disabled />
      <div id="dateError" class="error"></div>
    </div>

    <button id="bookBtn">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>

  <script>
    const WebApp = window.Telegram.WebApp;

    if (!WebApp) {
      alert("Telegram WebApp –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram.");
      throw new Error("WebApp not available");
    }

    WebApp.ready();
    WebApp.expand();

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞—ë–º —Ü–≤–µ—Ç–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ç–µ–º—É Telegram
    document.documentElement.style.setProperty('--tg-theme-bg-color', '#d9f2d9');
    document.documentElement.style.setProperty('--tg-theme-text-color', '#000000');
    document.documentElement.style.setProperty('--tg-theme-button-color', '#3390ec');
    document.documentElement.style.setProperty('--tg-theme-button-text-color', '#ffffff');
    document.documentElement.style.setProperty('--tg-theme-hint-color', '#999999');

    // –ö–æ–Ω—Ñ–∏–≥ —Å ID
    const HOTELS_CONFIG = {
      "1": { name: "–ê–ª—å—Ñ–∞", categories: [{"id": 1, "name": "–°—Ç–∞–Ω–¥–∞—Ä—Ç"}, {"id": 2, "name": "–õ—é–∫—Å"}], maxGuests: { "–°—Ç–∞–Ω–¥–∞—Ä—Ç": 2, "–õ—é–∫—Å": 4 } },
      "2": { name: "–ë–µ—Ç–∞", categories: [{"id": 3, "name": "–°—Ç–∞–Ω–¥–∞—Ä—Ç"}, {"id": 4, "name": "–ü–æ–ª—É–ª—é–∫—Å"}, {"id": 5, "name": "–õ—é–∫—Å"}], maxGuests: { "–°—Ç–∞–Ω–¥–∞—Ä—Ç": 2, "–ü–æ–ª—É–ª—é–∫—Å": 3, "–õ—é–∫—Å": 4 } },
      "3": { name: "–ì–∞–º–º–∞", categories: [{"id": 6, "name": "–°—Ç–∞–Ω–¥–∞—Ä—Ç"}, {"id": 7, "name": "–°–µ–º–µ–π–Ω—ã–π"}], maxGuests: { "–°—Ç–∞–Ω–¥–∞—Ä—Ç": 2, "–°–µ–º–µ–π–Ω—ã–π": 4 } }
    };

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('issueDate').max = today;
    document.getElementById('check_in').min = today;
    document.getElementById('check_out').min = today;

    const hotelSelect = document.getElementById('hotel_id');
    const categorySelect = document.getElementById('room_category_id');
    const guestsInput = document.getElementById('guests');
    const formFields = document.querySelectorAll('input:not([type="radio"]), select, textarea');
    const bookBtn = document.getElementById('bookBtn');

    hotelSelect.addEventListener('change', () => {
      const hotel_id = hotelSelect.value;
      categorySelect.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      categorySelect.disabled = !hotel_id;

      if (hotel_id && HOTELS_CONFIG[hotel_id]) {
        HOTELS_CONFIG[hotel_id].categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.id;           // ‚Üê ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          opt.textContent = cat.name;   // ‚Üê –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          categorySelect.appendChild(opt);
        });
        enableFields(true);
      } else {
        enableFields(false);
      }
    });

    categorySelect.addEventListener('change', () => {
      const hotel_id = hotelSelect.value;
      const room_category_id = categorySelect.value;
      if (hotel_id && room_category_id && HOTELS_CONFIG[hotel_id]) {
        const max = HOTELS_CONFIG[hotel_id].maxGuests[room_category_id] || 2;
        guestsInput.max = max;
        guestsInput.value = Math.min(guestsInput.value, max);
      }
    });

    function enableFields(enable) {
      formFields.forEach(el => {
        if (el.id !== 'hotel_id') el.disabled = !enable;
      });
      bookBtn.disabled = !enable;
    }

    document.getElementById('check_in').addEventListener('change', function () {
      document.getElementById('check_out').min = this.value || today;
    });

    document.getElementById('passportSeries').addEventListener('input', function (e) {
      this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });
    document.getElementById('passportNumber').addEventListener('input', function (e) {
      this.value = this.value.replace(/\D/g, '').slice(0, 6);
    });

    document.getElementById('phone').addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.startsWith('8')) value = '7' + value.slice(1);
      if (!value.startsWith('7')) value = '7' + value;
      let formatted = '+7';
      if (value.length > 1) formatted += ' (' + value.slice(1, 4);
      if (value.length >= 4) formatted += ') ' + value.slice(4, 7);
      if (value.length >= 7) formatted += '-' + value.slice(7, 9);
      if (value.length >= 9) formatted += '-' + value.slice(9, 11);
      e.target.value = formatted;
    });
    
    function focusField(fieldId, message = "") {
      const field = document.getElementById(fieldId);
      if (field) {
        field.scrollIntoView({ behavior: "smooth", block: "center" });
        field.focus();
        if (message) {
          WebApp.showAlert(message);
        }
      }
    }
 
    bookBtn.addEventListener('click', () => {
      const hotel_id = hotelSelect.value;
      const room_category_id = categorySelect.value;
      const guests = parseInt(document.getElementById('guests').value);
      const lastName = document.getElementById('lastName').value.trim();
      const firstName = document.getElementById('firstName').value.trim();
      const middleName = document.getElementById('middleName').value.trim() || null;
      const email = document.getElementById('email').value.trim() || null;
      const passportSeries = document.getElementById('passportSeries').value;
      const passportNumber = document.getElementById('passportNumber').value;
      const issueDate = document.getElementById('issueDate').value;
      const issuedBy = document.getElementById('issuedBy').value.trim();
      const phoneRaw = document.getElementById('phone').value.replace(/\D/g, '');
      const comment = document.getElementById('comment').value.trim() || null;
      const check_in = document.getElementById('check_in').value;
      const check_out = document.getElementById('check_out').value;

      const guestsError = document.getElementById('guestsError');
      const dateError = document.getElementById('dateError');
      guestsError.textContent = '';
      dateError.textContent = '';

      if (!hotel_id) { focusField('hotel_id', '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Å—Ç–∏–Ω–∏—Ü—É'); return; }
      if (!room_category_id) { focusField('room_category_id', '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }
      if (isNaN(guests) || guests < 1) {
        guestsError.textContent = '–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π';
        focusField('guests');
        return;
      }
      const maxGuests = HOTELS_CONFIG[hotel_id]?.maxGuests[room_category_id] || 2;
      if (guests > maxGuests) {
        guestsError.textContent = `–ú–∞–∫—Å–∏–º—É–º ${maxGuests} –≥–æ—Å—Ç–µ–π –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏`;
        focusField('guests');
        return;
      }
      if (!lastName) { focusField('lastName', '–§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞'); return; }
      if (!firstName) { focusField('firstName', '–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'); return; }
      if (passportSeries.length !== 4) { focusField('passportSeries', '–°–µ—Ä–∏—è ‚Äî 4 —Ü–∏—Ñ—Ä—ã'); return; }
      if (passportNumber.length !== 6) { focusField('passportNumber', '–ù–æ–º–µ—Ä ‚Äî 6 —Ü–∏—Ñ—Ä'); return; }
      if (!issueDate) { focusField('issueDate', '–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞'); return; }
      if (!issuedBy) { focusField('issuedBy', '–£–∫–∞–∂–∏—Ç–µ, –∫–µ–º –≤—ã–¥–∞–Ω'); return; }
      if (phoneRaw.length < 11) { focusField('phone', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω'); return; }
      if (!check_in) { focusField('check_in', '–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞'); return; }
      if (!check_out) { focusField('check_out', '–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞'); return; }
      if (new Date(check_out) <= new Date(check_in)) {
        dateError.textContent = '–í—ã–µ–∑–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–∑–∂–µ –∑–∞–µ–∑–¥–∞';
        focusField('check_out');
        return;
      }
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        focusField('email', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
        return;
      }

      const payload = {
        hotel_id: parseInt(hotel_id),           // ‚Üê ID –≥–æ—Å—Ç–∏–Ω–∏—Ü—ã
        room_category_id: parseInt(room_category_id), // ‚Üê ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        guests,
        lastName,
        firstName,
        middleName,
        email,
        passportSeries,
        passportNumber,
        issueDate,
        issuedBy,
        phone: '+7' + phoneRaw.slice(1),
        comment,
        check_in,
        check_out
      };

      WebApp.showAlert("–î–∞–Ω–Ω—ã–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã", payload);
      try {
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:', payload);
        WebApp.sendData(JSON.stringify(payload));
        //WebApp.close();
      } catch (e) {
        WebApp.showAlert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
      }
    });
  </script>
</body>
</html>
